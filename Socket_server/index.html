<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    Hello
    <script src="/socket.io/socket.io.js"></script>
    <script src="/tf.min.js"></script>
    <script src="/teachablemachine-image.min.js"></script>
    <script>
      let host = window.location.host;
      var socket = io("http://" + host);
      socket.on("connect", function () {
        console.log("Connected to server");
      });

      socket.on("command", async (data) => {
        console.log(data);
        if (data === "start") {
          await init();
        }
      });

      socket.on("disconnect", function () {
        console.log("Disconnected from server");
      });
      const URL = "http://" + window.location.host;

      let model, labelContainer, maxPredictions;

      // Load the image model
      async function init() {
        const modelURL = URL + "/model.json";
        const metadataURL = URL + "/metadata.json";

        // load the model and metadata
        model = await tmImage.load(modelURL, metadataURL);

        predict();
      }

      // predict the image
      async function predict() {
        const image = await loadImageFromURL("https://banknotecoinstamp.com/cdn/shop/products/476-3_1024x1024.jpg");
        const prediction = await model.predict(image);
        let highestPrediction = 0;
        let highestClass = "";
        for (let i = 0; i < maxPredictions; i++) {
          if (prediction[i].probability > highestPrediction) {
            highestPrediction = prediction[i].probability;
            highestClass = prediction[i].className;
          }
        }
        console.log(highestClass);
        socket.emit("prediction", highestClass);
      }

      // load image from input
      async function loadImageFromURL(url) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = "Anonymous"; // This may be required to avoid CORS issues
          img.onload = function () {
            resolve(img);
          };
          img.onerror = function () {
            reject(new Error("Failed to load image from URL"));
          };
          img.src = url;
        });
      }
    </script>
  </body>
</html>
